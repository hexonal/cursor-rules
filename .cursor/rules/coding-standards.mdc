---
description: 
globs: 
alwaysApply: false
---
# å°ç¨‹åºç¼–ç è§„èŒƒ

---
## ğŸ“‹ è§„åˆ™å…ƒæ•°æ®
- **è§„åˆ™ç±»å‹**: å¹³å°åŸºç¡€è§„åˆ™ (Platform Foundation Rules)
- **ä½œç”¨åŸŸ**: ä»£ç é£æ ¼ã€å‘½åçº¦å®šã€ç»“æ„è§„èŒƒ
- **è‡ªåŠ¨é™„åŠ æ¡ä»¶**: æ‰€æœ‰ `*.js`, `*.ts` æ–‡ä»¶
- **ä¼˜å…ˆçº§**: åŸºç¡€è§„èŒƒ (Priority: 90)
- **è¢«å¼•ç”¨äº**: [å¾®ä¿¡å°ç¨‹åºå¼€å‘è§„åˆ™](mdc:.cursor/rules/miniprogram-development-rules.mdc)
- **å†²çªè§£å†³**: é¡¹ç›®ç‰¹å®šè§„èŒƒ > é€šç”¨ç¼–ç è§„èŒƒ

## ğŸ“š è§„åˆ™ä½œç”¨
- **ä»£ç ä¸€è‡´æ€§**: ç¡®ä¿å›¢é˜Ÿä»£ç é£æ ¼ç»Ÿä¸€
- **å¯è¯»æ€§æå‡**: æ ‡å‡†åŒ–å‘½åå’Œç»“æ„
- **ç»´æŠ¤æ•ˆç‡**: é™ä½ä»£ç ç†è§£å’Œç»´æŠ¤æˆæœ¬
---

## ğŸ“ ä»£ç é£æ ¼è§„èŒƒ

### å‘½åçº¦å®š
```javascript
// âœ… æ­£ç¡®çš„å‘½åæ–¹å¼
// 1. å˜é‡å’Œå‡½æ•°ä½¿ç”¨é©¼å³°å‘½å
const messageList = [];
const currentConversationID = '';

// 2. å¸¸é‡ä½¿ç”¨å¤§å†™ä¸‹åˆ’çº¿
const MAX_MESSAGE_LENGTH = 500;
const MESSAGE_TYPE_TEXT = 'text';

// 3. ç»„ä»¶æ–¹æ³•å‘½åè§„èŒƒ
methods: {
  // å…¬å…±æ–¹æ³•ä»¥$å¼€å¤´
  $sendMessage() {},
  
  // äº‹ä»¶å¤„ç†ä»¥handleå¼€å¤´
  handleUserInput() {},
  handleLongPress() {},
  
  // å†…éƒ¨æ–¹æ³•ä½¿ç”¨åŠ¨è¯+åè¯
  getMessage() {},
  updateMessageList() {},
  
  // å›è°ƒæ–¹æ³•ä»¥onå¼€å¤´
  onMessageReceived() {},
  onNetworkError() {},
}

// âŒ é”™è¯¯çš„å‘½åæ–¹å¼
const msg = [];           // è¿‡äºç®€ç•¥
const handleClick() {}    // ä¸å¤Ÿå…·ä½“
const getData() {}        // è¿‡äºæ³›åŒ–
```

### æ–‡ä»¶å‘½åè§„èŒƒ
```
components/
â”œâ”€â”€ MessageInput/        # ç»„ä»¶ç›®å½•ä½¿ç”¨PascalCase
â”‚   â”œâ”€â”€ index.js        # å…¥å£æ–‡ä»¶ç»Ÿä¸€å‘½åindex
â”‚   â”œâ”€â”€ index.wxml      # æ¨¡æ¿æ–‡ä»¶
â”‚   â”œâ”€â”€ index.wxss      # æ ·å¼æ–‡ä»¶
â”‚   â””â”€â”€ index.json      # é…ç½®æ–‡ä»¶
â””â”€â”€ utils/
    â”œâ”€â”€ message-parse.js # å·¥å…·æ–‡ä»¶ä½¿ç”¨kebab-case
    â””â”€â”€ date-formatter.js
```

## ğŸ¯ ä»£ç ç»“æ„è§„èŒƒ

### ç»„ä»¶ä»£ç ç»“æ„é¡ºåº
```javascript
Component({
  // 1. ç»„ä»¶é…ç½®
  options: {
    multipleSlots: true,
  },

  // 2. å±æ€§å®šä¹‰
  properties: {
    // æŒ‰å­—æ¯é¡ºåºæ’åˆ—
    conversation: { /* ... */ },
    messageList: { /* ... */ },
    unreadCount: { /* ... */ },
  },

  // 3. åˆå§‹æ•°æ®
  data: {
    // æŒ‰é€»è¾‘åˆ†ç»„ï¼Œæ·»åŠ æ³¨é‡Šè¯´æ˜
    // ç•Œé¢çŠ¶æ€
    isShowConversation: false,
    popupToggle: false,
    
    // ä¸šåŠ¡æ•°æ®
    messageList: [],
    currentUser: {},
    
    // é…ç½®ä¿¡æ¯
    config: {},
  },

  // 4. ç”Ÿå‘½å‘¨æœŸï¼ˆæŒ‰æ‰§è¡Œé¡ºåºï¼‰
  lifetimes: {
    created() {},
    attached() {},
    ready() {},
    moved() {},
    detached() {},
  },

  // 5. é¡µé¢ç”Ÿå‘½å‘¨æœŸ
  pageLifetimes: {
    show() {},
    hide() {},
  },

  // 6. ç»„ä»¶æ–¹æ³•ï¼ˆæŒ‰åŠŸèƒ½åˆ†ç»„ï¼‰
  methods: {
    // åˆå§‹åŒ–æ–¹æ³•
    init() {},
    initCallKit() {},
    
    // å…¬å…±APIæ–¹æ³•
    $sendMessage() {},
    $getMessage() {},
    
    // äº‹ä»¶å¤„ç†æ–¹æ³•
    handleUserInput() {},
    handleSendMessage() {},
    
    // å†…éƒ¨é€»è¾‘æ–¹æ³•
    formatMessage() {},
    validateInput() {},
    
    // æ¸…ç†æ–¹æ³•
    destroy() {},
    cleanup() {},
  },
});
```

### å‡½æ•°è®¾è®¡è§„èŒƒ
```javascript
// âœ… å¥½çš„å‡½æ•°è®¾è®¡
// 1. å•ä¸€èŒè´£ï¼ŒåŠŸèƒ½æ˜ç¡®
function formatMessageTime(timestamp) {
  return dayjs(timestamp).format('HH:mm');
}

// 2. å‚æ•°æ ¡éªŒ
function sendMessage(message) {
  if (!message || !message.content) {
    throw new Error('Message content is required');
  }
  // å‘é€é€»è¾‘...
}

// 3. é”™è¯¯å¤„ç†
async function uploadFile(file) {
  try {
    const result = await wx.uploadFile(file);
    return result;
  } catch (error) {
    logger.error('Upload failed:', error);
    throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
  }
}

// 4. é€‚å½“çš„æ³¨é‡Š
/**
 * å¤„ç†é•¿æŒ‰å½•éŸ³åŠŸèƒ½
 * @param {Object} e - äº‹ä»¶å¯¹è±¡
 * @param {Object} e.touches - è§¦æ‘¸ç‚¹ä¿¡æ¯
 */
handleLongPress(e) {
  this.setData({
    startPoint: e.touches[0],
    isRecording: true,
  });
}
```

## ğŸ“‹ æ³¨é‡Šè§„èŒƒ

### æ–‡ä»¶å¤´æ³¨é‡Š
```javascript
/**
 * @fileoverview æ¶ˆæ¯è¾“å…¥ç»„ä»¶ - æ”¯æŒæ–‡æœ¬ã€è¯­éŸ³ã€å›¾ç‰‡ç­‰å¤šç§æ¶ˆæ¯ç±»å‹è¾“å…¥
 * @author å¼€å‘è€…å§“å
 * @date 2024-01-01
 * @version 1.0.0
 */
```

### å‡½æ•°æ³¨é‡Š
```javascript
/**
 * å‘é€æ–‡æœ¬æ¶ˆæ¯
 * @param {string} content - æ¶ˆæ¯å†…å®¹
 * @param {Object} options - å¯é€‰é…ç½®
 * @param {string} options.conversationID - ä¼šè¯ID
 * @param {boolean} options.needReceipt - æ˜¯å¦éœ€è¦å·²è¯»å›æ‰§
 * @returns {Promise<Object>} å‘é€ç»“æœ
 * @throws {Error} å½“æ¶ˆæ¯å†…å®¹ä¸ºç©ºæ—¶æŠ›å‡ºé”™è¯¯
 */
async sendTextMessage(content, options = {}) {
  // å®ç°é€»è¾‘...
}
```

### ä¸šåŠ¡é€»è¾‘æ³¨é‡Š
```javascript
methods: {
  handleTouchStart() {
    // æ£€æŸ¥å½•éŸ³æƒé™
    wx.getSetting({
      success: async (res) => {
        const isRecord = res.authSetting['scope.record'];
        // é¦–æ¬¡è·å–æƒé™æ—¶, isRecord === undefined
        // éœ€ä½¿ç”¨ recorderManager å†…ç½®è°ƒç”¨æƒé™åŠŸèƒ½
        if (isRecord === false) {
          // é¦–æ¬¡æœªæˆæƒï¼Œéœ€è¦èµ° wx.authorize æˆæƒæµç¨‹
          this.requestRecordPermission();
        } else {
          this.recorderStart();
        }
      },
    });
  },
}
```

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†è§„èŒƒ

### ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼
```javascript
// å‚è€ƒ [utils/constant.js](mdc:utils/constant.js) çš„é”™è¯¯ç è®¾è®¡
const ErrorHandler = {
  // ç½‘ç»œé”™è¯¯å¤„ç†
  handleNetworkError(error) {
    wx.showToast({
      title: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
      icon: 'none',
    });
    logger.error('Network error:', error);
  },

  // ä¸šåŠ¡é”™è¯¯å¤„ç†
  handleBusinessError(errorCode) {
    const errorMap = {
      [constant.MESSAGE_ERROR_CODE.DIRTY_WORDS]: 'æ¶ˆæ¯åŒ…å«è¿ç¦è¯æ±‡',
      [constant.MESSAGE_ERROR_CODE.UPLOAD_FAIL]: 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥',
      // æ›´å¤šé”™è¯¯ç ...
    };
    
    const message = errorMap[errorCode] || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
    wx.showToast({
      title: message,
      icon: 'none',
    });
  },
};
```

### é˜²å¾¡æ€§ç¼–ç¨‹
```javascript
// âœ… å¥½çš„é˜²å¾¡æ€§ç¼–ç¨‹
methods: {
  updateMessageList(newMessage) {
    // å‚æ•°æ ¡éªŒ
    if (!newMessage || typeof newMessage !== 'object') {
      logger.warn('Invalid message object');
      return;
    }

    // è¾¹ç•Œæ¡ä»¶æ£€æŸ¥
    const messageList = this.data.messageList || [];
    if (messageList.length >= MAX_MESSAGE_COUNT) {
      logger.warn('Message list exceeds maximum count');
      messageList.shift(); // ç§»é™¤æœ€æ—©çš„æ¶ˆæ¯
    }

    // å®‰å…¨çš„æ•°æ®æ›´æ–°
    this.setData({
      messageList: [...messageList, newMessage],
    });
  },
}
```
